version: 2

jobs:
  test:
    machine: true
    steps:
      - checkout
      - run:
          name: Install Docker Compose
          command: |
            curl -L https://github.com/docker/compose/releases/download/1.24.0/docker-compose-`uname -s`-`uname -m` > ~/docker-compose
            chmod +x ~/docker-compose
            sudo mv ~/docker-compose /usr/local/bin/docker-compose
            docker-compose -v

      - run:
          name: Set Environment variables
          command: |
            echo 'export SUBNET=192.168.10.1/24' >> $BASH_ENV
            echo 'export WEB_PORT=8000' >> $BASH_ENV
            echo 'export DB_PORT=8001' >> $BASH_ENV
            echo 'export STORYBOOK_PORT=8002' >> $BASH_ENV

      - run:
          name: Build Docker Test Images
          command: |
            docker-compose build

      - run:
          name: Test Migration
          command: |
            docker-compose run --rm migration alembic upgrade head
            docker-compose run --rm migration alembic downgrade base

      - run:
          name: Tpye check App
          command: |
            docker-compose run --rm app mypy .

      - run:
          name: Lint App
          command: |
            docker-compose run --rm  app sh fix_lint.sh

      - run:
          name: Test App
          command: |
            docker-compose run --rm app pytest

      - run:
          name: Type Check Board 
          command: |
            docker-compose run --rm board yarn tsc

      - run:
          name: Lint Board 
          command: |
            docker-compose run --rm board yarn lint


  deploy:
    machine: true
    steps:
      - checkout
      - run:
          name: Install Docker Compose
          command: |
            curl -L https://github.com/docker/compose/releases/download/1.19.0/docker-compose-`uname -s`-`uname -m` > ~/docker-compose
            chmod +x ~/docker-compose
            sudo mv ~/docker-compose /usr/local/bin/docker-compose
            docker-compose -v

      - run:
          name: push docker image
          command: |
            docker-compose -f docker-compose.build.yml push


workflows:
  version: 2
  test_and_deploy:
    jobs:
      - test

      - deploy
        filters:
          branches:
            only:
              - master
