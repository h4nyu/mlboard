version: 2

jobs:
  test:
    machine: true
    steps:
      - checkout
      - run:
          name: Install Docker Compose
          command: |
            curl -L https://github.com/docker/compose/releases/download/1.24.0/docker-compose-`uname -s`-`uname -m` > ~/docker-compose
            chmod +x ~/docker-compose
            sudo mv ~/docker-compose /usr/local/bin/docker-compose
            docker-compose -v

      - run:
          name: Set Environment variables
          command: |
            echo 'export SUBNET=192.168.10.1/24' >> $BASH_ENV
            echo 'export WEB_PORT=8000' >> $BASH_ENV
            echo 'export DB_PORT=8001' >> $BASH_ENV
            echo 'export STORYBOOK_PORT=8002' >> $BASH_ENV

      - run:
          name: Build Docker Test Images
          command: |
            docker-compose build

      - run:
          name: Test Migration
          command: |
            docker-compose run --rm migration alembic upgrade head

      - run:
          name: Lint App
          command: |
            docker-compose run --rm  app pipenv run lint

      - run:
          name: Test App
          command: |
            docker-compose run --rm  app pipenv run test

      - run:
          name: Install Dependencies
          command: |
            docker-compose run --rm board npm i

      - run:
          name: Lint Board 
          command: |
            docker-compose run --rm board npm run lint


  deploy:
    machine: true
    steps:
      - checkout
      - run:
          name: Install Docker Compose
          command: |
            curl -L https://github.com/docker/compose/releases/download/1.19.0/docker-compose-`uname -s`-`uname -m` > ~/docker-compose
            chmod +x ~/docker-compose
            sudo mv ~/docker-compose /usr/local/bin/docker-compose
            docker-compose -v

      - run:
          name: Build Production Images
          command: |
            docker-compose -f ./docker-compose.yml -f ./docker-compose.build.yml build
      - run:
          name: Push Images
          command: |
            docker login -u $DOCKER_USER -p $DOCKER_PASS
            docker-compose -f ./docker-compose.yml -f ./docker-compose.build.yml push



workflows:
  version: 2
  test_and_deploy:
    jobs:
      - test
      - deploy:
          requires:
            - test
          filters:
            branches:
              only: master
